<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CBT Sekolah</title>
</head>
<body>

<h2>LOGIN CBT</h2>
NIS <input id="nis"><br>
Token <input id="token"><br>
<button onclick="login()">Masuk</button>

<hr>

<div id="ujian" style="display:none">
<h3 id="identitas"></h3>
<div id="timer"></div>
<div id="soal"></div>
<button onclick="submit()">Selesai</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBjQVE8cnvc9e_zZW6Umvf_52Tgurhdoy8zlSENfbnp6-HFGPp6UDMK1GUc9U-9bE/exec";

let NIS="", startTime=0;

function login(){
fetch(API+`?action=login&nis=${nis.value}&token=${token.value}`)
.then(r=>r.json())
.then(res=>{
 if(res.status=="OK"){
   NIS=nis.value;
   identitas.innerText=res.nama+" - "+res.kelas;
   document.getElementById("ujian").style.display="block";
   startTime=Date.now();
   timerMulai();
   loadSoal();
 } else alert(res.status);
});
}

function loadSoal(){
fetch(API+"?action=getSoal")
.then(r=>r.json())
.then(data=>{
 let html="";
 data.forEach((s,i)=>{
   html+=`<p>${i+1}. ${s.soal}</p>`;
   s.opsi.forEach(o=>{
     html+=`
     <input type="radio" name="${s.id}"
     onchange="save(${s.id},'${o.k}')">
     ${o.k}. ${o.v}<br>`;
   });
 });
 soal.innerHTML=html;
});
}

function save(id,j){
fetch(API+`?action=save&nis=${NIS}&id=${id}&jawab=${j}`);
}

function submit(){
fetch(API+`?action=submit&nis=${NIS}`)
.then(r=>r.json())
.then(res=>alert("Skor: "+res.skor));
}

function timerMulai(){
let s=3600;
setInterval(()=>{
 let m=Math.floor(s/60);
 let d=s%60;
 timer.innerText="Waktu: "+m+":"+d;
 if(--s<=0) submit();
},1000);
}

window.onbeforeunload=()=>"Ujian belum selesai!";
document.oncontextmenu=()=>false;
document.oncopy=()=>false;
</script>
</body>
</html>
