<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CBT Sekolah</title>
</head>
<body>

<h2>LOGIN CBT</h2>
NIS <input id="nis"><br>
Token <input id="token"><br>
<button onclick="login()">Masuk</button>

<hr>

<div id="ujian" style="display:none">
<h3 id="identitas"></h3>
<div id="soal"></div>
<button onclick="submit()">Selesai</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycby-4PUJRxpcHnO2nxafjD6XByTmrgRhou98cpYFX6I4TV8BAxNs9_NH5l5OUfxmq8zS/exec";

let NIS="";

function getJSON(url){
  return fetch(url,{
    method:"GET",
    mode:"no-cors"
  })
}

async function login(){
  let url = API + "?action=login&nis="+nis.value+"&token="+token.value;

  let response = await fetch(url);
  let text = await response.text();

  try{
    let res = JSON.parse(text);
    if(res.status=="OK"){
      NIS=nis.value;
      identitas.innerText=res.nama+" - "+res.kelas;
      document.getElementById("ujian").style.display="block";
      loadSoal();
    }else{
      alert(res.status);
    }
  }catch(e){
    alert("Script belum di-deploy dengan benar.");
  }
}

async function loadSoal(){
  let response = await fetch(API+"?action=getSoal");
  let text = await response.text();
  let data = JSON.parse(text);

  let html="";
  data.forEach((s,i)=>{
    html+=`<p>${i+1}. ${s.soal}</p>`;
    s.opsi.forEach(o=>{
      html+=`
      <input type="radio" name="${s.id}"
      onchange="save(${s.id},'${o.k}')">
      ${o.k}. ${o.v}<br>`;
    });
  });
  soal.innerHTML=html;
}

function save(id,j){
  fetch(API+`?action=save&nis=${NIS}&id=${id}&jawab=${j}`);
}

async function submit(){
  let response = await fetch(API+`?action=submit&nis=${NIS}`);
  let text = await response.text();
  let res = JSON.parse(text);
  alert("Skor: "+res.skor);
}
</script>

</body>
</html>
